<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>WhatsApp Bot Dashboard</title>
        <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet"
        />
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    </head>
    <body class="bg-light">
        <div class="container mt-5">
        <h2 class="text-center mb-4">WhatsApp Bot Dashboard</h2>

        <div id="wa-status" class="text-center mb-3">
            <span class="badge bg-secondary">Memeriksa status WhatsApp...</span>
        </div>

        <div id="qrcode" class="d-flex justify-content-center mb-4"></div>

        <form id="send-message-form" class="row g-3 mb-4">
            <div class="col-md-4">
            <input
                type="text"
                id="number"
                class="form-control"
                placeholder="Masukkan nomor (628xxxxxxx)"
                required
            />
            </div>
            <div class="col-md-6">
            <input
                type="text"
                id="message"
                class="form-control"
                placeholder="Tulis pesan"
                required
            />
            </div>
            <div class="col-md-2 d-grid">
            <button type="submit" class="btn btn-primary">Kirim Pesan</button>
            </div>
        </form>

        <h5>Pesan Masuk</h5>
        <div
            id="chat-box"
            class="border rounded p-3 bg-white"
            style="height: 300px; overflow-y: auto"
        >
            <div class="text-center text-muted">Menunggu pesan masuk...</div>
        </div>
        </div>

        <script>
        const socket = io();
        const qrcodeContainer = document.getElementById("qrcode");
        const waStatus = document.getElementById("wa-status");
        const form = document.getElementById("send-message-form");
        const chatBox = document.getElementById("chat-box");

        function updateWAStatus(connected) {
            waStatus.innerHTML = connected
            ? '<span class="badge bg-success">âœ… WhatsApp Terhubung</span>'
            : '<span class="badge bg-danger">ðŸ”Œ WhatsApp Belum Terhubung</span>';

            // Sembunyikan QR jika sudah terhubung
            if (connected) {
            qrcodeContainer.innerHTML = "";
            }
        }

        socket.on("qr", (src) => {
            updateWAStatus(false);
            qrcodeContainer.innerHTML = `<img src="${src}" alt="QR Code" class="img-fluid" style="max-width: 250px;" />`;
        });

        socket.on("whatsapp-connection", (connected) => {
            updateWAStatus(connected);
        });

        socket.on("alert", (data) => {
            Swal.fire({
            icon: data.icon,
            title: data.title,
            text: data.text,
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 4000,
            timerProgressBar: true,
            });
        });

        socket.on("message", (msg) => {
            const from = msg.from.split("@")[0];
            const messageEl = document.createElement("div");
            messageEl.classList.add("mb-2", "p-2", "rounded");
            messageEl.style.backgroundColor = "#f8f9fa";

            messageEl.innerHTML = `<b>${from}:</b> ${msg.body}`;
            chatBox.appendChild(messageEl);
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const number = document.getElementById("number").value.trim();
            const message = document.getElementById("message").value.trim();

            if (!number || !message) {
            Swal.fire({
                icon: "warning",
                title: "Form belum lengkap",
                text: "Mohon isi nomor dan pesan.",
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
            });
            return;
            }

            socket.emit("send-message", { number, message });

            // Tampilkan pesan sendiri secara langsung
            const tempEl = document.createElement("div");
            tempEl.classList.add("mb-2", "p-2", "rounded", "text-end");
            tempEl.style.backgroundColor = "#d0ebff";
            tempEl.innerHTML = `<b>Saya:</b> ${message}`;
            chatBox.appendChild(tempEl);
            chatBox.scrollTop = chatBox.scrollHeight;

            document.getElementById("message").value = "";
        });
        </script>
    </body>
</html>
